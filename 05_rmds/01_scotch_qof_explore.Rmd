---
title: "Scotch QOF Analaysis"
subtitle: "Exploratory analysis"
author: "David Henderson"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    code_folding: hide
    theme: spacelab
    toc: true
    toc_float: true
    df_print: paged
    highlight: haddock
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 12, fig.height = 9,
                      warning = FALSE, message = FALSE,
                      class.source="bg-success")
```


# Introduction

Initial analysis of qof data

Import and clean TQA data - needs to be made long

Have a look at what is measurable back the way. Import those

Then find SIMD and UR etc for each practice

Then start descriptives

## Software

R packages and required helper functions.

```{r, warning=FALSE, message=FALSE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(here))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(lubridate))

source(here("01_functions/davidhen_helper_funcs_settings.R"))

```


# Load Data

## Post-2016 TQA data 

There is a combined 2016-2019 achievement file for TQA

```{r}
tqa <- read_excel(here("03_data/TQA/IR2019-00546 TQA Achievement2016-2019.xlsx"), 
                  sheet = "Data") |>
  clean_names()
```

## Pre 2016 QOF data

## SIMD and UR data


# Clean Data

## Post-2016 TQA data

```{r}
tqa |> 
  separate(year, c("fin_year", "meh"), sep = " ") |> 
  select(-meh, -ends_with("_perc")) |> 
  mutate(across(is.character, .fns = str_trim)) -> tqa

tqa |>
  select(-ends_with("_den")) |> 
  pivot_longer(ends_with("_num"), names_to = "indicator", 
               values_to = "ind_num") |> 
  mutate(indicator = str_remove(indicator, "_num")) -> tqa_num


tqa |>
  select(-ends_with("_num")) |> 
  pivot_longer(ends_with("_den"), names_to = "indicator", 
               values_to = "ind_den") |> 
  mutate(indicator = str_remove(indicator, "_den")) -> tqa_den

left_join(tqa_num, tqa_den) |> 
  mutate(ind_perc = ind_num/ind_den * 100) |> 
  arrange(practice, indicator, fin_year) -> tqa

rm(list = c("tqa_num", "tqa_den"))

tqa
```



```{r}
unique(tqa$indicator)
```


## Pre-2016 QOF data

## SIMD and UR data






